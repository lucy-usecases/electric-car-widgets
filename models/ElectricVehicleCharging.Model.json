{
  "version": "2.0",
  "models": [
    {
      "Key": "11",
      "Name": "ElectricVehicleCharging",
      "Definition": {
        "version": "v2",
        "readme": "This model provides an API to receive data related to electric vehicle chargers.\n\nChargers are known as 'stations'.\n\nEach station can send data about each charge session and the model will collate it and provide statistics on it.",
        "attributes": [],
        "flows": {
          "blocks": [
            {
              "title": "Action",
              "type": "actionstart",
              "id": "635ce430-dd34-4117-ffa7-d39dffc00bfe",
              "position": {
                "left": 60,
                "top": 60
              },
              "surface": "DeleteAllStations",
              "connections": {
                "inputs": [],
                "outputs": [
                  {
                    "source": "635ce430-dd34-4117-ffa7-d39dffc00bfe:output:output",
                    "target": "77c7e122-333f-465a-e815-bd0a2e2312bd:input:trigger"
                  }
                ]
              },
              "inputValues": [],
              "outputValues": [
                {
                  "id": "output",
                  "type": "",
                  "label": "All Output",
                  "description": "",
                  "documentation": "",
                  "example": "",
                  "dataType": ""
                },
                {
                  "id": "__error__",
                  "type": "error",
                  "label": "Error",
                  "description": "",
                  "documentation": "",
                  "example": "",
                  "dataType": ""
                }
              ],
              "actionName": "DeleteAllStations",
              "initiate": false,
              "published": false,
              "debug": false,
              "roles": [],
              "static": true,
              "canOverrideCredentials": false,
              "docs": "Delete all charging station configuration data."
            },
            {
              "title": "Output",
              "type": "actionoutput",
              "id": "53768aad-8e86-46e9-f0c4-708f341fc529",
              "position": {
                "left": 762,
                "top": 99
              },
              "surface": "RecordCharge",
              "connections": {
                "inputs": [
                  {
                    "source": "610b2c05-e65d-4839-e317-7eb11da8ef09:output:done",
                    "target": "53768aad-8e86-46e9-f0c4-708f341fc529:input:input"
                  }
                ],
                "outputs": []
              },
              "inputValues": [
                {
                  "id": "input",
                  "type": "",
                  "label": "Value",
                  "value": "ok",
                  "description": "",
                  "documentation": "",
                  "transformation": "",
                  "disablelog": ""
                },
                {
                  "id": "trigger",
                  "type": "",
                  "label": "Trigger",
                  "value": "",
                  "description": "",
                  "documentation": "",
                  "transformation": "",
                  "disablelog": ""
                }
              ],
              "outputValues": [],
              "fieldName": "status"
            },
            {
              "title": "Action",
              "type": "actionstart",
              "id": "e7b2a2b6-5bb9-4ae6-98bc-0a4745f2e6cb",
              "position": {
                "left": 100,
                "top": 100
              },
              "surface": "RecordCharge",
              "connections": {
                "inputs": [],
                "outputs": [
                  {
                    "source": "e7b2a2b6-5bb9-4ae6-98bc-0a4745f2e6cb:output:sessions",
                    "target": "610b2c05-e65d-4839-e317-7eb11da8ef09:input:sessions"
                  }
                ]
              },
              "inputValues": [],
              "outputValues": [
                {
                  "id": "output",
                  "type": "",
                  "label": "All Output",
                  "description": "",
                  "documentation": "",
                  "example": "",
                  "dataType": ""
                },
                {
                  "id": "__error__",
                  "type": "error",
                  "label": "Error",
                  "description": "",
                  "documentation": "",
                  "example": "",
                  "dataType": ""
                },
                {
                  "id": "sessions",
                  "type": "",
                  "label": "sessions",
                  "description": "",
                  "documentation": "A list of charge sessions",
                  "example": "[\n   {\"station\":\"station-1.0\",\"chargeStartTime\":\"2021-03-01T00:00:00Z\",\"duration\":3600,\"power\":18},\n   {\"station\":\"station-2.0\",\"chargeStartTime\":\"2021-03-01T01:19:00Z\",\"duration\":1923,\"power\":8}\n]",
                  "dataType": ""
                }
              ],
              "actionName": "RecordCharge",
              "initiate": false,
              "published": false,
              "debug": false,
              "roles": [],
              "static": true,
              "canOverrideCredentials": false,
              "docs": "Upload charging sessions from the EV chargers.\n\nEach session contains\n\n* `station` which is a unique station id for the charging station\n* `chargeStartTime` -the time at which charging started, in UTC\n* `duration` - the charging duration in seconds\n* `power` - the amount of power consumed while charging in kWh\n\n# Output\n\n```\n{\"status\":\"ok\"}\n```"
            },
            {
              "title": "ES6Javascript",
              "type": "es6javascript",
              "id": "610b2c05-e65d-4839-e317-7eb11da8ef09",
              "position": {
                "left": 320,
                "top": 100
              },
              "surface": "RecordCharge",
              "connections": {
                "inputs": [
                  {
                    "source": "e7b2a2b6-5bb9-4ae6-98bc-0a4745f2e6cb:output:sessions",
                    "target": "610b2c05-e65d-4839-e317-7eb11da8ef09:input:sessions"
                  }
                ],
                "outputs": [
                  {
                    "source": "610b2c05-e65d-4839-e317-7eb11da8ef09:output:done",
                    "target": "53768aad-8e86-46e9-f0c4-708f341fc529:input:input"
                  },
                  {
                    "source": "610b2c05-e65d-4839-e317-7eb11da8ef09:output:done",
                    "target": "a625172f-7d7a-48ce-8c63-b999ea61cc43:input:trigger"
                  }
                ]
              },
              "inputValues": [
                {
                  "id": "trigger",
                  "type": "",
                  "label": "Trigger",
                  "value": "",
                  "description": "",
                  "documentation": "",
                  "transformation": "",
                  "disablelog": ""
                },
                {
                  "id": "sessions",
                  "type": "",
                  "label": "sessions",
                  "value": "",
                  "description": "",
                  "documentation": "",
                  "transformation": "",
                  "disablelog": ""
                }
              ],
              "outputValues": [
                {
                  "id": "__error__",
                  "type": "error",
                  "label": "Error",
                  "description": "",
                  "documentation": "",
                  "example": "",
                  "dataType": ""
                },
                {
                  "id": "done",
                  "type": "",
                  "label": "done",
                  "description": "",
                  "documentation": "",
                  "example": "",
                  "dataType": ""
                }
              ],
              "description": "",
              "code": "let {sessions} = runtime.inputs();\nlet stationMap = {};\nasync function main() {\n    var t = lucy.trends();\n    let points = [];\n    for(var s of sessions) {\n\n        if (!s.station) {\n            continue;\n        }\n        \n        points.push({\n            trend:`/evcharging/duration`,\n            value:Number(s.duration),\n            timestamp:lucy.parseDateTime(s.chargeStartTime),\n            tags:{station:s.station||''}    \n        });\n        // points.push({\n        //     trend:`/evcharging/${s.station}/duration`,\n        //     value:Number(s.duration),\n        //     timestamp:lucy.parseDateTime(s.chargeStartTime),\n        //     tags:{station:s.station||''}    \n        // });\n\n        points.push({\n            trend:`/evcharging/power`,\n            value:Number(s.power),\n            timestamp:lucy.parseDateTime(s.chargeStartTime),\n            tags:{station:s.station||''}                 \n        });\n        stationMap[s.station] = 1;\n    }\n\n    await t.addPoints(points,{});\n\n    let dc = lucy.currentModel().collections();\n    for(let station of Object.keys(stationMap)) {\n        await dc.updateOne('stations',{id:station},{'$set':{id:station}},{});\n    }\n\n}\n\nmain().then(_ => runtime.done({done:1})).catch(e => runtime.error(e));",
              "timeoutMilliseconds": 5000
            },
            {
              "title": "ES6Javascript",
              "type": "es6javascript",
              "id": "b139dd38-72e3-4f21-d096-4e02862b1594",
              "position": {
                "left": 360,
                "top": 158
              },
              "surface": "StationUsage",
              "connections": {
                "inputs": [
                  {
                    "source": "95535e66-fb0d-48f0-f080-63e3a47ca40c:output:start",
                    "target": "b139dd38-72e3-4f21-d096-4e02862b1594:input:start"
                  },
                  {
                    "source": "95535e66-fb0d-48f0-f080-63e3a47ca40c:output:end",
                    "target": "b139dd38-72e3-4f21-d096-4e02862b1594:input:end"
                  }
                ],
                "outputs": [
                  {
                    "source": "b139dd38-72e3-4f21-d096-4e02862b1594:output:stations",
                    "target": "0c415451-224c-45bb-d481-b49073ab021c:input:input"
                  }
                ]
              },
              "inputValues": [
                {
                  "id": "trigger",
                  "type": "",
                  "label": "Trigger",
                  "value": "",
                  "description": "",
                  "documentation": "",
                  "transformation": "",
                  "disablelog": ""
                },
                {
                  "id": "start",
                  "type": "",
                  "label": "start",
                  "value": "",
                  "description": "",
                  "documentation": "",
                  "transformation": "datetime",
                  "disablelog": ""
                },
                {
                  "id": "end",
                  "type": "",
                  "label": "end",
                  "value": "",
                  "description": "",
                  "documentation": "",
                  "transformation": "datetime",
                  "disablelog": ""
                }
              ],
              "outputValues": [
                {
                  "id": "__error__",
                  "type": "error",
                  "label": "Error",
                  "description": "",
                  "documentation": "",
                  "example": "",
                  "dataType": ""
                },
                {
                  "id": "stations",
                  "type": "",
                  "label": "stations",
                  "description": "",
                  "documentation": "",
                  "example": "",
                  "dataType": ""
                }
              ],
              "description": "",
              "code": "let dc = lucy.currentModel().collections();\nlet trends = lucy.trends();\nlet { start, end } = runtime.inputs();\n\nasync function main() {\n    let stations = await dc.findMany('stations', {}, {});\n    let stationResults = [];\n    for (let station of stations) {\n        let charge = { power: 0, duration: 0,charges:0,station:station.id };\n        \n        let results = await trends.queryPoints(`/evcharging/duration`, start, end, { station: station.id }, '', '', {limit:1000});\n        charge.duration = results.reduce((old, x) => old + Number(x.Value), 0);\n\n        charge.charges = results.length;\n\n\n        let powerResults = await trends.queryPoints(`/evcharging/power`, start, end, { station: station.id }, '', '', {limit:1000});\n        charge.power = powerResults.reduce((old, x) => old + Number(x.Value), 0);\n        \n        stationResults.push(charge)\n\n    }\n\n    return stationResults;\n}\nmain().then(_ => runtime.done({ stations: _ })).catch(e => runtime.error(e));",
              "timeoutMilliseconds": 5000
            },
            {
              "title": "PublishMessage",
              "type": "publishmessage",
              "id": "a625172f-7d7a-48ce-8c63-b999ea61cc43",
              "position": {
                "left": 769,
                "top": 419
              },
              "surface": "RecordCharge",
              "connections": {
                "inputs": [
                  {
                    "source": "610b2c05-e65d-4839-e317-7eb11da8ef09:output:done",
                    "target": "a625172f-7d7a-48ce-8c63-b999ea61cc43:input:trigger"
                  }
                ],
                "outputs": []
              },
              "inputValues": [
                {
                  "id": "channel",
                  "type": "",
                  "label": "Channel",
                  "value": "lxp/ev",
                  "description": "",
                  "documentation": "",
                  "transformation": "",
                  "disablelog": ""
                },
                {
                  "id": "message",
                  "type": "",
                  "label": "Message",
                  "value": "1",
                  "description": "",
                  "documentation": "",
                  "transformation": "",
                  "disablelog": ""
                },
                {
                  "id": "trigger",
                  "type": "",
                  "label": "Trigger",
                  "value": "",
                  "description": "",
                  "documentation": "",
                  "transformation": "",
                  "disablelog": ""
                }
              ],
              "outputValues": [
                {
                  "id": "done",
                  "type": "",
                  "label": "Done",
                  "description": "",
                  "documentation": "",
                  "example": "",
                  "dataType": ""
                }
              ]
            },
            {
              "title": "Output",
              "type": "actionoutput",
              "id": "0c415451-224c-45bb-d481-b49073ab021c",
              "position": {
                "left": 796,
                "top": 102
              },
              "surface": "StationUsage",
              "connections": {
                "inputs": [
                  {
                    "source": "b139dd38-72e3-4f21-d096-4e02862b1594:output:stations",
                    "target": "0c415451-224c-45bb-d481-b49073ab021c:input:input"
                  }
                ],
                "outputs": []
              },
              "inputValues": [
                {
                  "id": "input",
                  "type": "",
                  "label": "Value",
                  "value": "",
                  "description": "",
                  "documentation": "",
                  "transformation": "",
                  "disablelog": ""
                },
                {
                  "id": "trigger",
                  "type": "",
                  "label": "Trigger",
                  "value": "",
                  "description": "",
                  "documentation": "",
                  "transformation": "",
                  "disablelog": ""
                }
              ],
              "outputValues": [],
              "fieldName": ""
            },
            {
              "title": "Delete all document",
              "type": "modelcollections:deleteall",
              "id": "77c7e122-333f-465a-e815-bd0a2e2312bd",
              "position": {
                "left": 425,
                "top": 57
              },
              "surface": "DeleteAllStations",
              "connections": {
                "inputs": [
                  {
                    "source": "635ce430-dd34-4117-ffa7-d39dffc00bfe:output:output",
                    "target": "77c7e122-333f-465a-e815-bd0a2e2312bd:input:trigger"
                  }
                ],
                "outputs": []
              },
              "inputValues": [
                {
                  "id": "trigger",
                  "type": "",
                  "label": "Trigger",
                  "value": "",
                  "description": "",
                  "documentation": "",
                  "transformation": "",
                  "disablelog": ""
                }
              ],
              "outputValues": [
                {
                  "id": "__error__",
                  "type": "error",
                  "label": "Error",
                  "description": "",
                  "documentation": "",
                  "example": "",
                  "dataType": ""
                },
                {
                  "id": "output",
                  "type": "",
                  "label": "All Output",
                  "description": "",
                  "documentation": "",
                  "example": "",
                  "dataType": ""
                }
              ],
              "CollectionName": "86454804-101e-4d6a-a4cd-7a9067d6f508",
              "configuration": "[]",
              "UpdateAsAttributes": false,
              "ReceiveIndividualFields": false,
              "TakeFilterFromPin": false,
              "timeout": 5000
            },
            {
              "title": "Action",
              "type": "actionstart",
              "id": "95535e66-fb0d-48f0-f080-63e3a47ca40c",
              "position": {
                "left": 59,
                "top": 129
              },
              "surface": "StationUsage",
              "connections": {
                "inputs": [],
                "outputs": [
                  {
                    "source": "95535e66-fb0d-48f0-f080-63e3a47ca40c:output:start",
                    "target": "b139dd38-72e3-4f21-d096-4e02862b1594:input:start"
                  },
                  {
                    "source": "95535e66-fb0d-48f0-f080-63e3a47ca40c:output:end",
                    "target": "b139dd38-72e3-4f21-d096-4e02862b1594:input:end"
                  }
                ]
              },
              "inputValues": [],
              "outputValues": [
                {
                  "id": "output",
                  "type": "",
                  "label": "All Output",
                  "description": "",
                  "documentation": "",
                  "example": "",
                  "dataType": ""
                },
                {
                  "id": "__error__",
                  "type": "error",
                  "label": "Error",
                  "description": "",
                  "documentation": "",
                  "example": "",
                  "dataType": ""
                },
                {
                  "id": "start",
                  "type": "",
                  "label": "start",
                  "description": "",
                  "documentation": "",
                  "example": "",
                  "dataType": ""
                },
                {
                  "id": "end",
                  "type": "",
                  "label": "end",
                  "description": "",
                  "documentation": "",
                  "example": "",
                  "dataType": ""
                }
              ],
              "actionName": "StationUsage",
              "initiate": false,
              "published": false,
              "debug": true,
              "roles": [],
              "static": true,
              "canOverrideCredentials": false,
              "docs": ""
            }
          ],
          "position": {
            "top": 0,
            "left": 0
          }
        },
        "sources": [
          {
            "name": "RecordCharge",
            "published": false,
            "static": true,
            "initiate": false,
            "canOverrideCredentials": false,
            "outputs": [
              "status"
            ],
            "parameters": [
              "sessions"
            ]
          },
          {
            "name": "StationUsage",
            "published": false,
            "static": true,
            "initiate": false,
            "canOverrideCredentials": false,
            "outputs": [
              ""
            ],
            "parameters": [
              "start",
              "end"
            ]
          },
          {
            "name": "DeleteAllStations",
            "published": false,
            "static": true,
            "initiate": false,
            "canOverrideCredentials": false,
            "outputs": [],
            "parameters": []
          }
        ],
        "actions": [
          {
            "name": "RecordCharge",
            "published": false,
            "static": true,
            "initiate": false,
            "canOverrideCredentials": false,
            "outputs": [
              "status"
            ],
            "parameters": [
              "sessions"
            ]
          },
          {
            "name": "StationUsage",
            "published": false,
            "static": true,
            "initiate": false,
            "canOverrideCredentials": false,
            "outputs": [
              ""
            ],
            "parameters": [
              "start",
              "end"
            ]
          },
          {
            "name": "DeleteAllStations",
            "published": false,
            "static": true,
            "initiate": false,
            "canOverrideCredentials": false,
            "outputs": [],
            "parameters": []
          }
        ],
        "uioptions": {}
      },
      "UIDefinition": null,
      "MetadataDictionary": "null",
      "Icon": "",
      "ApiRoutes": [
        {
          "Key": "1033",
          "MapKey": "11",
          "Route": "charging",
          "Method": "POST",
          "BodyFormat": "JSON",
          "QueryParams": "[]",
          "IsActive": "0",
          "Action": "RecordCharge",
          "NoAuth": "0"
        },
        {
          "Key": "1034",
          "MapKey": "11",
          "Route": "usage",
          "Method": "GET",
          "BodyFormat": "JSON",
          "QueryParams": "[{\"name\":\"start\",\"description\":\"Start of the time range\"},{\"name\":\"end\",\"description\":\"End of the time range\"}]",
          "IsActive": "0",
          "Action": "StationUsage",
          "NoAuth": "0"
        },
        {
          "Key": "1035",
          "MapKey": "11",
          "Route": "station",
          "Method": "DELETE",
          "BodyFormat": "JSON",
          "QueryParams": "[]",
          "IsActive": "0",
          "Action": "DeleteAllStations",
          "NoAuth": "0"
        }
      ],
      "JSModules": [],
      "ModelCollections": [
        {
          "Key": "343",
          "MapKey": "11",
          "GUID": "86454804-101e-4d6a-a4cd-7a9067d6f508",
          "Attributes": "[{\"name\":\"id\"},{\"name\":\"label\"}]",
          "Name": "stations"
        }
      ]
    }
  ]
}